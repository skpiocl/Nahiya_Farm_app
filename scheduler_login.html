<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Scheduler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; background: #f4f4f4; color: #333; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Header & Status Indicator Styles */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .system-status { font-weight: bold; font-size: 0.9em; padding: 5px 12px; border-radius: 20px; background: #ddd; color: #666; display: flex; align-items: center; gap: 8px; }
        .dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; }
        
        /* Status Colors */
        .status-online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-online .dot { background-color: #28a745; box-shadow: 0 0 5px #28a745; }
        .status-offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-offline .dot { background-color: #dc3545; }
        
        h2 { margin-top: 0; font-size: 1.2em; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
        label { display: block; margin: 12px 0 5px; font-weight: 600; font-size: 0.9em; color: #555; }
        select, input, button { width: 100%; padding: 12px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        select:focus, input:focus { outline: none; border-color: #007bff; }
        
        /* Buttons */
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: 600; margin-top: 10px; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.delete { background: #fff; color: #dc3545; border: 1px solid #dc3545; width: auto; padding: 6px 12px; font-size: 14px; margin-top: 0; }
        button.delete:hover { background: #dc3545; color: white; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95em; }
        th { text-align: left; padding: 10px; background: #f8f9fa; color: #666; font-weight: 600; border-bottom: 2px solid #ddd; }
        td { text-align: left; padding: 12px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        small { color: #888; }
        
        /* Connection Status Footer */
        #mqtt-debug { text-align: center; font-size: 0.8em; color: #999; margin-top: 20px; }

        /* --- NEW LOGIN MODAL STYLES --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 12px;
            width: 90%; max-width: 400px; text-align: center;
        }
        .login-box h2 { border: none; }
        .error-msg { color: #dc3545; font-size: 0.9em; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>üîê Farm Access</h2>
            <p style="color:#666; margin-bottom:20px;">Enter MQTT Credentials to connect.</p>
            <div id="loginError" class="error-msg">Connection Failed. Check password.</div>
            
            <label style="text-align:left;">Username</label>
            <input type="text" id="mqttUser" placeholder="e.g. skp">
            
            <label style="text-align:left;">Password</label>
            <input type="password" id="mqttPass" placeholder="Enter Password">
            
            <button onclick="attemptLogin()" id="btnLogin">Connect</button>
        </div>
    </div>

    <div class="header-row">
        <h1 style="margin:0; font-size:1.5em;">üöú Farm Control</h1>
        <div id="sysStatus" class="system-status">
            <span class="dot"></span> <span id="sysText">Waiting for login...</span>
        </div>
    </div>

    <div class="card">
        <h2>üìÖ Schedule New Task</h2>
        
        <label>Device Type</label>
        <select id="devType" onchange="updateDeviceList()">
            <option value="pump">Pump</option>
            <option value="valve">Valve</option>
            <option value="music">Music Player üéµ</option> </select>

        <label id="devNameLabel">Device Name</label>
        <select id="devName"></select>

        <div id="sourceWrapper">
            <label>Power Source</label>
            <select id="devSource">
                <option value="own_solar">Own Solar</option>
                <option value="sarkari_solar">Sarkari Solar</option>
            </select>
        </div>

        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>Start Date & Time</label>
                <input type="datetime-local" id="startTime">
            </div>
            <div style="flex:1;">
                <label>Duration (Mins)</label>
                <input type="number" id="duration" value="60" min="1">
            </div>
        </div>

        <button onclick="scheduleTask()" id="btnSave" disabled>Save Schedule</button>
    </div>

    <div class="card">
        <div class="header-row" style="margin-bottom:0;">
            <h2>üìã Active Schedules</h2>
            <button onclick="getSchedule()" style="width:auto; background:transparent; color:#007bff; border:1px solid #007bff; padding:5px 10px; font-size:0.9em;">‚Üª Refresh</button>
        </div>
        <table id="taskTable">
            <thead><tr><th>Device</th><th>Start Time</th><th>Dur</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="4" style="text-align:center; color:#999;">Not Connected</td></tr></tbody>
        </table>
    </div>

    <div id="mqtt-debug">MQTT Status: Waiting for user input...</div>

    <script>
        // --- CONFIGURATION ---
        const MQTT_HOST = "t7ef11fa.ala.asia-southeast1.emqxsl.com";
        const MQTT_PORT = 8084;
        const MQTT_CLIENT_ID = "web_sched_" + Math.random().toString(16).substr(2, 8);
        
        // REMOVED HARDCODED USER/PASS
        let MQTT_USER = ""; 
        let MQTT_PASS = ""; 
        
        const TOPIC_CMD = "farm/commands";
        const TOPIC_SCHED_DATA = "farm/status/schedule";
        const TOPIC_HEARTBEAT = "farm/status"; 

        // --- DATA ---
        const pumps = ["gate_bore", "talaab_bore", "pandubbi", "sarkari", "middle"];
        const valves = ["bore_valves", "talaab_valves", "pandubbi_valves", "farm_house_valves", "upper_hill_mango", "lower_hill_mango", "lemon"];
        const playlists = ["Morning_Routine", "Evening_Relax", "Siren_Alert", "Farm_Radio"];

        // --- STATE ---
        let lastHeartbeat = 0;
        let heartbeatInterval = null;
        let pingInterval = null;
        let client = null;

        // --- LOGIN LOGIC ---
        function attemptLogin() {
            const user = document.getElementById("mqttUser").value;
            const pass = document.getElementById("mqttPass").value;
            const btn = document.getElementById("btnLogin");
            const err = document.getElementById("loginError");

            if(!user || !pass) {
                alert("Please enter both username and password");
                return;
            }

            // Update UI to show loading
            btn.innerText = "Connecting...";
            btn.disabled = true;
            err.style.display = "none";

            // Set global vars
            MQTT_USER = user;
            MQTT_PASS = pass;

            // Initialize Client
            connect();
        }

        function connect() {
            client = new Paho.MQTT.Client(MQTT_HOST, Number(MQTT_PORT), MQTT_CLIENT_ID);

            // Set Callbacks
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            document.getElementById("mqtt-debug").innerText = "MQTT Status: Connecting...";
            
            client.connect({
                useSSL: true,
                userName: MQTT_USER,
                password: MQTT_PASS,
                onSuccess: onConnect,
                onFailure: onConnectFailure
            });
        }

        function onConnect() {
            // Hide Login Modal on success
            document.getElementById("loginOverlay").style.display = "none";
            document.getElementById("mqtt-debug").innerText = "MQTT Status: Connected";
            
            client.subscribe(TOPIC_SCHED_DATA);
            client.subscribe(TOPIC_HEARTBEAT);
            getSchedule();
            
            if(pingInterval) clearInterval(pingInterval);
            pingInterval = setInterval(sendPing, 5000); 
            sendPing();

            if(heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(checkHeartbeat, 2000);
        }

        function onConnectFailure(e) {
            document.getElementById("mqtt-debug").innerText = "MQTT Status: Failed (" + e.errorMessage + ")";
            
            // Re-enable login form
            const btn = document.getElementById("btnLogin");
            const err = document.getElementById("loginError");
            btn.innerText = "Connect";
            btn.disabled = false;
            
            // Show error inside modal
            err.style.display = "block";
            err.innerText = "Error: " + e.errorMessage;
        }

        function onConnectionLost(obj) { 
            document.getElementById("mqtt-debug").innerText = "MQTT Status: Connection Lost (" + obj.errorMessage + ")";
            setSystemStatus("offline");
            // Optional: If you want to force login again on disconnect, uncomment below:
            // document.getElementById("loginOverlay").style.display = "flex";
        }

        function onMessageArrived(msg) {
            if (msg.destinationName === TOPIC_SCHED_DATA) {
                renderTable(JSON.parse(msg.payloadString));
            }
            if (msg.destinationName === TOPIC_HEARTBEAT) {
                lastHeartbeat = Date.now();
                setSystemStatus("online");
            }
        };

        function sendPing() {
            if(client.isConnected()) {
                const msg = new Paho.MQTT.Message(JSON.stringify({type: "mqtt_command", data: {action: "get_status"}}));
                msg.destinationName = TOPIC_CMD;
                client.send(msg);
            }
        }

        function checkHeartbeat() {
            const now = Date.now();
            if (now - lastHeartbeat > 10000) {
                setSystemStatus("offline");
            }
        }

        function setSystemStatus(status) {
            const el = document.getElementById("sysStatus");
            const txt = document.getElementById("sysText");
            const btn = document.getElementById("btnSave");

            el.className = "system-status"; 
            if (status === "online") {
                el.classList.add("status-online");
                txt.innerText = "System Online";
                btn.disabled = false;
                btn.innerText = "Save Schedule";
            } else {
                el.classList.add("status-offline");
                txt.innerText = "System Offline";
            }
        }

        // --- FORM LOGIC ---
        function updateDeviceList() {
            const type = document.getElementById("devType").value;
            const nameSelect = document.getElementById("devName");
            const nameLabel = document.getElementById("devNameLabel");
            const sourceWrapper = document.getElementById("sourceWrapper");
            
            nameSelect.innerHTML = "";
            let list = [];

            if (type === "pump") {
                list = pumps;
                nameLabel.innerText = "Pump Name";
                sourceWrapper.style.display = "block";
            } else if (type === "valve") {
                list = valves;
                nameLabel.innerText = "Valve Name";
                sourceWrapper.style.display = "none";
            } else if (type === "music") {
                list = playlists;
                nameLabel.innerText = "Playlist Name";
                sourceWrapper.style.display = "none";
            }
            
            list.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item;
                opt.innerText = item.replace(/_/g, " ").toUpperCase();
                nameSelect.appendChild(opt);
            });
        }

        function scheduleTask() {
            const startVal = document.getElementById("startTime").value;
            if(!startVal) { alert("Please pick a date and time!"); return; }

            const dt = new Date(startVal);
            const fmtDate = dt.getFullYear() + "-" + 
                String(dt.getMonth()+1).padStart(2,'0') + "-" + 
                String(dt.getDate()).padStart(2,'0') + " " + 
                String(dt.getHours()).padStart(2,'0') + ":" + 
                String(dt.getMinutes()).padStart(2,'0');

            const payload = {
                action: "schedule_task",
                device_type: document.getElementById("devType").value,
                device_name: document.getElementById("devName").value,
                source: document.getElementById("devType").value === "pump" ? document.getElementById("devSource").value : null,
                start_time: fmtDate,
                duration: document.getElementById("duration").value
            };

            const msg = new Paho.MQTT.Message(JSON.stringify({type: "mqtt_command", data: payload}));
            msg.destinationName = TOPIC_CMD;
            client.send(msg);
            
            setTimeout(getSchedule, 1000);
        }

        function deleteTask(id) {
            if(!confirm("Are you sure you want to delete this task?")) return;
            const payload = { action: "delete_schedule", task_id: id };
            const msg = new Paho.MQTT.Message(JSON.stringify({type: "mqtt_command", data: payload}));
            msg.destinationName = TOPIC_CMD;
            client.send(msg);
        }

        function getSchedule() {
            if(!client || !client.isConnected()) return;
            const payload = { action: "get_schedule" };
            const msg = new Paho.MQTT.Message(JSON.stringify({type: "mqtt_command", data: payload}));
            msg.destinationName = TOPIC_CMD;
            client.send(msg);
        }

        function renderTable(tasks) {
            const tbody = document.querySelector("#taskTable tbody");
            tbody.innerHTML = "";
            
            if (tasks.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px; color:#888;">No tasks scheduled</td></tr>`;
                return;
            }

            tasks.forEach(t => {
                const dateParts = t.start_time.split(" "); 
                const displayDate = dateParts[0].split("-").slice(1).join("/") + " " + dateParts[1]; 

                let statusStyle = "color:#007bff;";
                if(t.status === 'RUNNING') statusStyle = "color:#28a745; font-weight:bold;";

                let icon = "‚öôÔ∏è";
                if(t.device_type === 'pump') icon = "üíß";
                if(t.device_type === 'valve') icon = "üö∞";
                if(t.device_type === 'music') icon = "üéµ";

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600;">${icon} ${t.device_name.replace(/_/g, " ")}</div>
                        <div style="font-size:0.85em; color:#888;">${t.device_type.toUpperCase()} ${t.source ? '('+t.source.replace('_',' ')+')' : ''}</div>
                    </td>
                    <td>
                        ${displayDate}
                        <div style="font-size:0.8em; ${statusStyle}">${t.status}</div>
                    </td>
                    <td>${t.duration_minutes}m</td>
                    <td><button class="delete" onclick="deleteTask(${t.id})">Del</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Initialize (Only Update Lists, Do NOT Connect yet)
        updateDeviceList();
    </script>
</body>
</html>