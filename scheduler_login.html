<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Media Controller</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); padding: 15px; max-width: 500px; margin: auto; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* Now Playing HUD */
        .hud { text-align: center; background: #1e293b; color: white; position: sticky; top: 0; z-index: 100; }
        .song-title { color: #38bdf8; font-weight: bold; display: block; margin-bottom: 5px; height: 24px; overflow: hidden; }
        .progress-container { background: #475569; border-radius: 10px; height: 6px; width: 100%; margin: 10px 0; cursor: pointer; }
        .progress-bar { background: #38bdf8; height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s; }
        
        /* Controls */
        .nav-controls { display: flex; justify-content: space-around; align-items: center; margin: 10px 0; }
        .btn-nav { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .btn-play { background: #2563eb; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Queue Dropdown */
        .queue-box { display: none; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; margin-top: 10px; text-align: left; max-height: 200px; overflow-y: auto; }
        
        /* Library Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 10px 5px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .seq-col { width: 30px; color: #94a3b8; font-size: 0.8em; }

        .yt-section input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
        .mode-row { display: flex; gap: 5px; margin-top: 10px; }
        .mode-btn { flex: 1; padding: 5px; font-size: 0.75em; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
        .active-mode { background: #2563eb; color: white; border-color: #2563eb; }
    </style>
</head>
<body>

    <div class="card hud">
        <span id="now-playing" class="song-title">Select a Song</span>
        <div class="progress-container" onclick="handleSeek(event)">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.7em; color: #94a3b8;">
            <span id="time-curr">00:00</span>
            <span id="vol-pct">Volume: 100%</span>
            <span id="time-total">00:00</span>
        </div>

        <div class="nav-controls">
            <button class="btn-nav" onclick="sendMusicCmd('music_seek', {seconds: -15})">⏪</button>
            <button class="btn-nav" onclick="sendMusicCmd('music_prev')">⏮</button>
            <button class="btn-nav btn-play" onclick="sendMusicCmd('stop_music')">⏹</button>
            <button class="btn-nav" onclick="sendMusicCmd('music_next')">⏭</button>
            <button class="btn-nav" onclick="sendMusicCmd('music_seek', {seconds: 15})">⏩</button>
        </div>
    </div>

    <div class="card yt-section">
        <input type="text" id="yt-url" placeholder="Paste YouTube Link...">
        <div class="mode-row">
            <button class="mode-btn" style="background:#ef4444; color:white;" onclick="playYT(false)">Play Now</button>
            <button class="mode-btn" style="background:#22c55e; color:white;" onclick="playYT(true)">+ Queue</button>
        </div>
        <div class="mode-row">
            <button id="m-manual" class="mode-btn" onclick="setMode('manual')">Manual</button>
            <button id="m-random" class="mode-btn" onclick="setMode('random')">Random</button>
            <button id="m-seq" class="mode-btn" onclick="setMode('sequential')">Sequential</button>
        </div>
    </div>

    <div class="card">
        <button onclick="toggleQueue()" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
            View Queue (<span id="q-count">0</span> songs)
        </button>
        <div id="queue-list" class="queue-box"></div>
    </div>

    <div class="card">
        <table id="lib-table">
            <thead><tr style="text-align: left; font-size: 0.8em; color: #64748b;"><th>#</th><th>Description</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let client;
        function connect() {
            client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "web_" + Math.random());
            client.onMessageArrived = onMessage;
            client.connect({ onSuccess: () => { 
                client.subscribe("farm/status");
                client.subscribe("farm/music/queue_detail");
                sendMusicCmd("get_status");
                sendMusicCmd("get_queue_detail");
            }, useSSL: true });
        }

        function onMessage(msg) {
            const data = JSON.parse(msg.payloadString);
            
            if (msg.destinationName === "farm/status" && data.music) {
                const m = data.music;
                document.getElementById("now-playing").innerText = m.current_song || "Stopped";
                document.getElementById("progress-bar").style.width = m.progress_pct + "%";
                document.getElementById("vol-pct").innerText = `Volume: ${m.volume}%`;
                document.getElementById("q-count").innerText = m.queue_len;
                
                // Update active mode buttons
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-mode'));
                if(m.playback_mode) document.getElementById('m-'+m.playback_mode.substring(0,3)).classList.add('active-mode');
            }

            if (msg.destinationName === "farm/music/queue_detail") {
                const qDiv = document.getElementById("queue-list");
                qDiv.innerHTML = data.length ? data.map((s, i) => `<div>${i+1}. ${s.name}</div>`).join('') : "Queue empty";
            }
        }

        function sendMusicCmd(action, extra = {}) {
            const message = new Paho.MQTT.Message(JSON.stringify({ action, ...extra }));
            message.destinationName = "farm/commands";
            client.send(message);
        }

        function playYT(toQueue) {
            const url = document.getElementById("yt-url").value;
            if(!url) return;
            sendMusicCmd("play_youtube", { url, add_to_queue: toQueue });
            document.getElementById("yt-url").value = "";
        }

        function toggleQueue() {
            const el = document.getElementById("queue-list");
            el.style.display = el.style.display === "block" ? "none" : "block";
            if(el.style.display === "block") sendMusicCmd("get_queue_detail");
        }

        function setMode(mode) { sendMusicCmd("set_playback_mode", { mode }); }

        window.onload = connect;
    </script>
</body>
</html>
